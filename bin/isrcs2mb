#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
#
# Simple command line tool to submit ISRCs from a CD to MusicBrainz.
# For usage details run "ruby isrcs2mb --help".
#
# Requirements:
# * Ruby
# * RBrainz and MB-DiscID (http://rbrainz.rubyforge.org)
# * icedax
# * HighLine (http://highline.rubyforge.org)
# * Launchy (optional, http://copiousfreetime.rubyforge.org/launchy/)
#
# Copyright (C) 2009-2010 Philipp Wolfer <ph.wolfer@googlemail.com>
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither the name of the RBrainz project nor the names of the
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
# TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

require 'rbrainz'
require 'discid'
require 'optparse'
require 'highline/import'
begin
  require 'rubygems'
  require 'launchy'
rescue LoadError
  Launchy = nil
end
include MusicBrainz

def read_isrcs(disc)
  isrcs = {}
    disc.tracks do |track|
      isrcs[track.number - 1] = Model::ISRC.parse(track.isrc) unless track.isrc.nil?
    end
    return isrcs
end

HighLine.track_eof = false
def get_choice(release)
  Proc.new { release }
end

def submit_release_question(disc)
  if Launchy
    if agree("Do you want to submit this release to MusicBrainz?")
      Launchy.open disc.submission_url
    end
  else
    say "Use the following URL to submit the release to MusicBrainz:\n%s" % disc.submission_url
  end
end

device = DiscId.default_device
username = ''
password = ''

# Read the command line parameters
opts = OptionParser.new do |o|
    o.banner = "Usage: isrcs2mb [options]"
    o.on( "-r", "--device DEVICE", "CD device." ) do |r|
        device = r
    end
    o.on( "-u", "--username USERNAME", "MusicBrainz username." ) do |u|
        username = u
    end
    o.on( "-p", "--password PASSWORD", "MusicBrainz password." ) do |p|
        password = p
    end
    o.on("-h", "--help", "This help message." ) do
        puts o
        exit
    end
end

opts.parse!(ARGV)

# Read the disc ID
begin
    say "Reading ISRCs from %s...\n" % device
    disc = DiscId.read(device, :isrc)
    say "Disc ID: %s" % disc.id
rescue Exception => e
    say "Can not read disc in %s" % device
    exit 1
end

isrcs = read_isrcs(disc)
say "%d ISRCs found." % isrcs.size

if isrcs.size == 0
    say "No ISRCs found, exiting."
    exit 1
end

isrcs.each do |number, isrc|
    say "%02d %s" % [number + 1, isrc]
end

# Ask for user credentials
if username.empty?
  username = ask("Username: ") do |q|
    q.validate = lambda { |a| not a.empty? }
    q.responses[:not_valid] = "Please enter a username."
  end
end

if password.empty?
  password = ask("Password: ") do |q|
    q.echo = "*"
    q.validate = lambda { |a| not a.empty? }
    q.responses[:not_valid] = "Please enter a password."
  end 
end

# Set the authentication for the webservice.
ws = Webservice::Webservice.new(
   :host     => 'musicbrainz.org',
   :username => username,
   :password => password
)

# Create a new Query object which will provide
# us an interface to the MusicBrainz web service.
query = Webservice::Query.new(ws, :client_id => 'isrcs2mb ISRC submission ' + RBRAINZ_VERSION)
releases = query.get_releases(:discid => disc)

if releases.size == 0
  say "\nNo release found. "
  submit_release_question(disc)
  exit 1
end

# Let the user select one release
release = choose do |menu|
  menu.header = "\nSelect release"
  for i in 0...releases.size do
    release = releases[i].entity
    text = "'%s' by '%s' (%s)" % [release, release.artist, release.id.uuid]
    menu.choice(text, &get_choice(release))
  end
  menu.choice("None of the above") do
    say "\nNo release found. "
    submit_release_question(disc)
    exit 1
  end
end

# Create a mapping between track IDs and ISRCs
track_isrc_map = []
for i in 0...release.tracks.size do
  track = release.tracks[i]
  isrc = isrcs[i]
  track_isrc_map << [track.id.uuid, isrc.to_str] unless isrc.nil?
end

# Submit the ISRCs for some tracks.
say "Submitting ISRCs for %d tracks to MusicBrainz... " % track_isrc_map.size
begin
  query.submit_isrcs(track_isrc_map)
rescue Webservice::AuthenticationError => e
  say "failed."
  say "Wrong username or password."
  exit 1
end
say "done."
exit
